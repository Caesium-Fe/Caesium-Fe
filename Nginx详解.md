# Django项目部署流程与Nginx安装配置

## 1. 什么是Nginx及其主要作用 

## nginx是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务。

1）反向代理服务器：位于客户端用户与目标服务器之间，用户直接访问反向代理服务器就可以获取目标服务器的资源。

2）什么是负载均衡：讲工作任务分摊到多个操作单元上进行执行。

3）理解动静分离：加快网站的解析速度，将动态和静态页面由不同服务器进行解析。

## 2. 实现Nginx反向代理

1）项目部署原理分析：在项目中，nginx负责接收客户端的请求（一个nginx服务器能够同同一时刻支持5万的并发量），并将请求分为动态和静态，而uWSGI就将nginx的请求转变为django web框架能够理解的形式发送给django，根据客户端请求，django将响应返回交给uWSGI，依次传递到nginx，返回给客户端。

```shell
##############http请求##############
#################↓##################
###############nginx################
#######↓#################↓##########
####静态请求###########动态请求#######
#######↓#################↓##########
####静态文件############uWSGI########
#####*.css###############↓##########
#####*.js##############Django#######
#####*.png################↓#########
#####*.html#############app_1#######
#####......#############app_2#######
```

2）nginx安装与配置

nginx分两种版本安装，生产环境一般是linux，而学习环境为windows，两种都介绍下：

```nginx
#linux版本通过查看 runoob.com/linux/nginx-install-setup.html 即可

#windows版本
进到官网：https://nginx.org/en/download.html，找到自己需要的版本进行下载，得到压缩包后进行解压。
解压完成后：在nginx的配置文件是conf目录下的nginx.conf，修改文件。

《第一部分：全局块》
 worker_processes  1;
从配置文件开始到events块之间的内容，主要会设置一些影响Nginx服务器整体运行的配置指令，主要包括：配置运行Nginx服务器的用户（组）、允许生成的 worker process 数，进程PID存放路径、日志存放路径和类型以及配置文件的引入等。
上面这行 worker_processes 配置，是 Nginx 服务器并发处理服务的关键配置，该值越大，可以支持的并发处理量也越多，但是会受到硬件、软件等设备的约束。

《第二部分：events 块》
events {
	worker_connections  1024;
}
events 块涉及的指令主要影响Nginx服务器与用户的网络连接，常用的设置包括：是否开启对多 work process下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型来处理连接请求，每个 work process 可以同时支持的最大连接数等

上述例子就表示每个 work process 支持的最大连接数为 1024。这部分的配置对Nginx的性能影响较大，在实际中应该灵活配置。
《第三部分：http 块》
这部分是 Nginx 服务器配置中最频繁的部分，代理、缓存和日志定义等绝大多数功能和第三方模块的配置都在这里。需要注意的是：http 块也可以包括 http 全局块、server 块。下面的反向代理、动静分离、负载均衡都是在这部分中配置
▪ http 全局块：http 全局块配置的指令包括：文件引入、MIME-TYPE 定义、日志自定义、连接超时时间、单链接请求数上限等。
▪ server 块：这块和虚拟主机有密切关系，从用户角度看，虚拟主机和一台独立的硬件主机是完全一样的，该技术的产生是为了节省互联网服务器硬件成本。
每个http块可以包括多个server块，而每个server块就相当于一个虚拟主机。而每个server块也分为全局server块，以及可以同时包含多个locaton块。（☆☆☆☆☆）

《全局 server 块》
最常见的配置是本虚拟机主机的监听配置和本虚拟主机的名称或IP配置。

《location 块》
一个 server 块可以配置多个 location 块。
这块的主要作用是：基于 Nginx 服务器接收到的请求字符串（例如 server_name/uri-string），对虚拟主机名称（也可以是 IP 别名）之外的字符串（例如 前面的 /uri-string）进行匹配，对特定的请求进行处理。地址定向、数据缓存和应答控制等功能，还有许多第三方模块的配置也在这里进行。
```

配置反向代理：server部分就是客户端访问的目标地址及端口，location部分就是被代理服务器地址（location部分还可以写成匹配指令）

```nginx
location指令：

该指令用于匹配 URL， 语法如下：

location [ = | ~ | ~* | ^~] url {
}
= ：用于不含正则表达式的 url 前，要求请求字符串与 url 严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求
~：用于表示 url 包含正则表达式，并且区分大小写
~*：用于表示 url 包含正则表达式，并且不区分大小写
^~：用于不含正则表达式的 url 前，要求 Nginx 服务器找到标识 url 和请求。字符串匹配度最高的 location 后，立即使用此 location 处理请求，而不再使用 location块中的正则 url 和请求字符串做匹配。
注意：如果 url 包含正则表达式，则必须要有 ~ 或者 ~* 标识
```

## 3.实现负载均衡

upstream：配置**负载均衡**，upstream 默认是以轮询的方式进行负载，另外还支持**四种模式**，分别是：

（1）weight：权重，指定轮询的概率，weight 与访问概率成正比

（2）ip_hash：按照访问 IP 的 hash 结果值分配

（3）fair：按后端服务器响应时间进行分配，响应时间越短优先级别越高

（4）url_hash：按照访问 URL 的 hash 结果值分配

如何实现：首先配置nginx.conf文件，在server的同一级新增upstream节点，设置对应的多个后端服务地址，这里设置的节点地址需要与代理跳转地址一致。

```nginx
upstream abc.com {  # 这里写的abc.com需要与下面location中proxy一致。
		server 127.0.0.1:9091; # 这里添加需要进行负载均衡的地址
		server 127.0.0.1:9092;
}
location / {
		proxy_pass http://abc.com;
}	
```

